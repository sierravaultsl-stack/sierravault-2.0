{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 16, "column": 0}, "map": {"version":3,"sources":["turbopack:///[project]/middleware.ts"],"sourcesContent":["import { NextResponse } from 'next/server'\r\nimport type { NextRequest } from 'next/server'\r\nimport { jwtVerify } from 'jose' // Using Jose for Edge compatibility\r\n\r\n// Secret key from env\r\nconst JWT_SECRET = process.env.JWT_SECRET || \"fallback-secret-change-me\";\r\nconst SECRET_KEY = new TextEncoder().encode(JWT_SECRET);\r\n\r\n// Protected Routes Defs\r\nconst GOV_ROUTES = /^\\/dashboard\\/gov/;\r\nconst CITIZEN_ROUTES = /^\\/dashboard\\/citizen/;\r\nconst GOV_API_ROUTES = /^\\/api\\/gov/;\r\n\r\nexport async function middleware(request: NextRequest) {\r\n    const { pathname } = request.nextUrl;\r\n\r\n    // 1. Skip public assets and auth routes\r\n    if (\r\n        pathname.startsWith('/_next') ||\r\n        pathname.startsWith('/static') ||\r\n        pathname.startsWith('/api/auth/login') ||\r\n        pathname.startsWith('/api/auth/register') ||\r\n        pathname === '/login' ||\r\n        pathname === '/'\r\n    ) {\r\n        return NextResponse.next();\r\n    }\r\n\r\n    // 2. Verify Token\r\n    const token = request.cookies.get('token')?.value;\r\n\r\n    if (!token) {\r\n        if (pathname.startsWith('/dashboard') || pathname.startsWith('/api')) {\r\n            // API generic 401\r\n            if (pathname.startsWith('/api')) {\r\n                return NextResponse.json({ error: 'Unauthorized' }, { status: 401 });\r\n            }\r\n            // Redirect to login\r\n            return NextResponse.redirect(new URL('/login', request.url));\r\n        }\r\n        return NextResponse.next();\r\n    }\r\n\r\n    try {\r\n        const { payload }: any = await jwtVerify(token, SECRET_KEY);\r\n        const role = payload.role; // citizen, gov\r\n\r\n        // 3. RBAC Enforcement mechanisms\r\n\r\n        // GOV ROUTES -> Must be a gov role\r\n        if (GOV_ROUTES.test(pathname) || GOV_API_ROUTES.test(pathname)) {\r\n            if (role !== 'gov') {\r\n                if (pathname.startsWith('/api')) {\r\n                    return NextResponse.json({ error: 'Forbidden: Government Access Only' }, { status: 403 });\r\n                }\r\n                return NextResponse.redirect(new URL('/dashboard/citizen', request.url));\r\n            }\r\n        }\r\n\r\n        // CITIZEN ROUTES -> Must be citizen (or maybe gov can view? Policy says gov views via their own dashboard)\r\n        // Strictly, let's keep citizens in citizen dash.\r\n        if (CITIZEN_ROUTES.test(pathname)) {\r\n            if (role !== 'citizen') {\r\n                if (pathname.startsWith('/api')) {\r\n                    return NextResponse.json({ error: 'Forbidden: Citizen Access Only' }, { status: 403 });\r\n                }\r\n                // Redirect gov users to their dash if they try accessing citizen pages\r\n                return NextResponse.redirect(new URL('/dashboard/gov', request.url));\r\n            }\r\n        }\r\n\r\n        // Pass user info via headers for API routes ease of use (optional but helpful)\r\n        const requestHeaders = new Headers(request.headers);\r\n        requestHeaders.set('x-user-id', payload.id as string);\r\n        requestHeaders.set('x-user-role', payload.role as string);\r\n\r\n        return NextResponse.next({\r\n            request: {\r\n                headers: requestHeaders,\r\n            },\r\n        });\r\n\r\n    } catch (err) {\r\n        // Token invalid/expired\r\n        if (pathname.startsWith('/api')) {\r\n            return NextResponse.json({ error: 'Invalid Token' }, { status: 401 });\r\n        }\r\n        const response = NextResponse.redirect(new URL('/login', request.url));\r\n        response.cookies.delete('token');\r\n        return response;\r\n    }\r\n}\r\n\r\nexport const config = {\r\n    matcher: ['/dashboard/:path*', '/api/:path*'],\r\n}\r\n"],"names":[],"mappings":";;;;;;AAAA;AAAA;AAEA,sWAAiC,oCAAoC;;;AAErE,sBAAsB;AACtB,MAAM,aAAa,QAAQ,GAAG,CAAC,UAAU,IAAI;AAC7C,MAAM,aAAa,IAAI,cAAc,MAAM,CAAC;AAE5C,wBAAwB;AACxB,MAAM,aAAa;AACnB,MAAM,iBAAiB;AACvB,MAAM,iBAAiB;AAEhB,eAAe,WAAW,OAAoB;IACjD,MAAM,EAAE,QAAQ,EAAE,GAAG,QAAQ,OAAO;IAEpC,wCAAwC;IACxC,IACI,SAAS,UAAU,CAAC,aACpB,SAAS,UAAU,CAAC,cACpB,SAAS,UAAU,CAAC,sBACpB,SAAS,UAAU,CAAC,yBACpB,aAAa,YACb,aAAa,KACf;QACE,OAAO,+TAAY,CAAC,IAAI;IAC5B;IAEA,kBAAkB;IAClB,MAAM,QAAQ,QAAQ,OAAO,CAAC,GAAG,CAAC,UAAU;IAE5C,IAAI,CAAC,OAAO;QACR,IAAI,SAAS,UAAU,CAAC,iBAAiB,SAAS,UAAU,CAAC,SAAS;YAClE,kBAAkB;YAClB,IAAI,SAAS,UAAU,CAAC,SAAS;gBAC7B,OAAO,+TAAY,CAAC,IAAI,CAAC;oBAAE,OAAO;gBAAe,GAAG;oBAAE,QAAQ;gBAAI;YACtE;YACA,oBAAoB;YACpB,OAAO,+TAAY,CAAC,QAAQ,CAAC,IAAI,IAAI,UAAU,QAAQ,GAAG;QAC9D;QACA,OAAO,+TAAY,CAAC,IAAI;IAC5B;IAEA,IAAI;QACA,MAAM,EAAE,OAAO,EAAE,GAAQ,MAAM,IAAA,6NAAS,EAAC,OAAO;QAChD,MAAM,OAAO,QAAQ,IAAI,EAAE,eAAe;QAE1C,iCAAiC;QAEjC,mCAAmC;QACnC,IAAI,WAAW,IAAI,CAAC,aAAa,eAAe,IAAI,CAAC,WAAW;YAC5D,IAAI,SAAS,OAAO;gBAChB,IAAI,SAAS,UAAU,CAAC,SAAS;oBAC7B,OAAO,+TAAY,CAAC,IAAI,CAAC;wBAAE,OAAO;oBAAoC,GAAG;wBAAE,QAAQ;oBAAI;gBAC3F;gBACA,OAAO,+TAAY,CAAC,QAAQ,CAAC,IAAI,IAAI,sBAAsB,QAAQ,GAAG;YAC1E;QACJ;QAEA,2GAA2G;QAC3G,iDAAiD;QACjD,IAAI,eAAe,IAAI,CAAC,WAAW;YAC/B,IAAI,SAAS,WAAW;gBACpB,IAAI,SAAS,UAAU,CAAC,SAAS;oBAC7B,OAAO,+TAAY,CAAC,IAAI,CAAC;wBAAE,OAAO;oBAAiC,GAAG;wBAAE,QAAQ;oBAAI;gBACxF;gBACA,uEAAuE;gBACvE,OAAO,+TAAY,CAAC,QAAQ,CAAC,IAAI,IAAI,kBAAkB,QAAQ,GAAG;YACtE;QACJ;QAEA,+EAA+E;QAC/E,MAAM,iBAAiB,IAAI,QAAQ,QAAQ,OAAO;QAClD,eAAe,GAAG,CAAC,aAAa,QAAQ,EAAE;QAC1C,eAAe,GAAG,CAAC,eAAe,QAAQ,IAAI;QAE9C,OAAO,+TAAY,CAAC,IAAI,CAAC;YACrB,SAAS;gBACL,SAAS;YACb;QACJ;IAEJ,EAAE,OAAO,KAAK;QACV,wBAAwB;QACxB,IAAI,SAAS,UAAU,CAAC,SAAS;YAC7B,OAAO,+TAAY,CAAC,IAAI,CAAC;gBAAE,OAAO;YAAgB,GAAG;gBAAE,QAAQ;YAAI;QACvE;QACA,MAAM,WAAW,+TAAY,CAAC,QAAQ,CAAC,IAAI,IAAI,UAAU,QAAQ,GAAG;QACpE,SAAS,OAAO,CAAC,MAAM,CAAC;QACxB,OAAO;IACX;AACJ;AAEO,MAAM,SAAS;IAClB,SAAS;QAAC;QAAqB;KAAc;AACjD"}}]
}