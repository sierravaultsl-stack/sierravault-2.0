{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 52, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/USER/Desktop/A10%20Projects/SierraVaultMain/lib/dbConnect.ts"],"sourcesContent":["import mongoose from 'mongoose';\r\n\r\nconst MONGODB_URI = process.env.MONGODB_URI;\r\n\r\nif (!MONGODB_URI) {\r\n  throw new Error('Please define the MONGODB_URI environment variable inside .env.local');\r\n}\r\n\r\n/**\r\n * Global is used here to maintain a cached connection across hot reloads\r\n * in development. This prevents connections growing exponentially\r\n * during API Route usage.\r\n */\r\nlet cached = (global as any).mongoose;\r\n\r\nif (!cached) {\r\n  cached = (global as any).mongoose = { conn: null, promise: null };\r\n}\r\n\r\nasync function dbConnect() {\r\n  if (cached.conn) {\r\n    return cached.conn;\r\n  }\r\n\r\n  if (!cached.promise) {\r\n    const opts = {\r\n      bufferCommands: false,\r\n    };\r\n\r\n    cached.promise = mongoose.connect(MONGODB_URI!, opts).then((mongoose) => {\r\n      return mongoose;\r\n    });\r\n  }\r\n\r\n  try {\r\n    cached.conn = await cached.promise;\r\n  } catch (e) {\r\n    cached.promise = null;\r\n    throw e;\r\n  }\r\n\r\n  return cached.conn;\r\n}\r\n\r\nexport default dbConnect;\r\n"],"names":[],"mappings":";;;;AAAA;;AAEA,MAAM,cAAc,QAAQ,GAAG,CAAC,WAAW;AAE3C,IAAI,CAAC,aAAa;IAChB,MAAM,IAAI,MAAM;AAClB;AAEA;;;;CAIC,GACD,IAAI,SAAS,yDAAgB,QAAQ;AAErC,IAAI,CAAC,QAAQ;IACX,SAAS,yDAAgB,QAAQ,GAAG;QAAE,MAAM;QAAM,SAAS;IAAK;AAClE;AAEA,eAAe;IACb,IAAI,OAAO,IAAI,EAAE;QACf,OAAO,OAAO,IAAI;IACpB;IAEA,IAAI,CAAC,OAAO,OAAO,EAAE;QACnB,MAAM,OAAO;YACX,gBAAgB;QAClB;QAEA,OAAO,OAAO,GAAG,oHAAQ,CAAC,OAAO,CAAC,aAAc,MAAM,IAAI,CAAC,CAAC;YAC1D,OAAO;QACT;IACF;IAEA,IAAI;QACF,OAAO,IAAI,GAAG,MAAM,OAAO,OAAO;IACpC,EAAE,OAAO,GAAG;QACV,OAAO,OAAO,GAAG;QACjB,MAAM;IACR;IAEA,OAAO,OAAO,IAAI;AACpB;uCAEe"}},
    {"offset": {"line": 98, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/USER/Desktop/A10%20Projects/SierraVaultMain/models/Document.ts"],"sourcesContent":["import mongoose, { Schema, Document, model, models } from \"mongoose\";\r\n\r\nexport interface IDocument extends Document {\r\n    userId: mongoose.Types.ObjectId; // Citizen Owner\r\n    type: string; // e.g., \"National ID\", \"Birth Certificate\"\r\n    title: string; // User-friendly name\r\n    url?: string; // File path or URL (Optional for requests)\r\n\r\n    // State Machine\r\n    status: \"PENDING_VERIFICATION\" | \"VERIFIED\" | \"ISSUED\" | \"REJECTED\" | \"EXPIRED\" | \"REQUESTED\";\r\n\r\n    // Metadata & AI\r\n    metadata: {\r\n        aiScore?: number;\r\n        aiFlags?: string[];\r\n        aiExplanation?: string;\r\n        extractedText?: string;\r\n        fileHash?: string;\r\n        mimeType?: string;\r\n        sizeBytes?: number;\r\n    };\r\n\r\n    // Government Audit Workflow\r\n    govAudit: {\r\n        uploadedBy?: mongoose.Types.ObjectId; // If Gov issued\r\n        verifiedBy?: mongoose.Types.ObjectId; // Gov User who verified\r\n        verifiedAt?: Date;\r\n        rejectedBy?: mongoose.Types.ObjectId;\r\n        rejectionReason?: string;\r\n        rejectedAt?: Date;\r\n        issuedAt?: Date;\r\n    };\r\n\r\n    createdAt: Date;\r\n    updatedAt: Date;\r\n}\r\n\r\nconst DocumentSchema = new Schema<IDocument>(\r\n    {\r\n        userId: { type: Schema.Types.ObjectId, ref: \"User\", required: true, index: true },\r\n        type: { type: String, required: true, index: true },\r\n        title: { type: String, required: true },\r\n        url: { type: String, required: false },\r\n\r\n        status: {\r\n            type: String,\r\n            enum: [\"PENDING_VERIFICATION\", \"VERIFIED\", \"ISSUED\", \"REJECTED\", \"EXPIRED\", \"REQUESTED\"],\r\n            default: \"PENDING_VERIFICATION\",\r\n            index: true,\r\n        },\r\n\r\n        metadata: {\r\n            aiScore: { type: Number },\r\n            aiFlags: [{ type: String }],\r\n            aiExplanation: { type: String },\r\n            extractedText: { type: String },\r\n            fileHash: { type: String },\r\n            mimeType: { type: String },\r\n            sizeBytes: { type: Number },\r\n        },\r\n\r\n        govAudit: {\r\n            uploadedBy: { type: Schema.Types.ObjectId, ref: \"User\" },\r\n            verifiedBy: { type: Schema.Types.ObjectId, ref: \"User\" },\r\n            verifiedAt: { type: Date },\r\n            rejectedBy: { type: Schema.Types.ObjectId, ref: \"User\" },\r\n            rejectionReason: { type: String },\r\n            rejectedAt: { type: Date },\r\n            issuedAt: { type: Date },\r\n        },\r\n    },\r\n    { timestamps: true }\r\n);\r\n\r\n// Indexes for common queries\r\nDocumentSchema.index({ \"govAudit.verifiedBy\": 1 });\r\nDocumentSchema.index({ createdAt: -1 });\r\n\r\nexport default models.Document || model<IDocument>(\"Document\", DocumentSchema);\r\n"],"names":[],"mappings":";;;;AAAA;;AAqCA,MAAM,iBAAiB,IAAI,mHAAM,CAC7B;IACI,QAAQ;QAAE,MAAM,mHAAM,CAAC,KAAK,CAAC,QAAQ;QAAE,KAAK;QAAQ,UAAU;QAAM,OAAO;IAAK;IAChF,MAAM;QAAE,MAAM;QAAQ,UAAU;QAAM,OAAO;IAAK;IAClD,OAAO;QAAE,MAAM;QAAQ,UAAU;IAAK;IACtC,KAAK;QAAE,MAAM;QAAQ,UAAU;IAAM;IAErC,QAAQ;QACJ,MAAM;QACN,MAAM;YAAC;YAAwB;YAAY;YAAU;YAAY;YAAW;SAAY;QACxF,SAAS;QACT,OAAO;IACX;IAEA,UAAU;QACN,SAAS;YAAE,MAAM;QAAO;QACxB,SAAS;YAAC;gBAAE,MAAM;YAAO;SAAE;QAC3B,eAAe;YAAE,MAAM;QAAO;QAC9B,eAAe;YAAE,MAAM;QAAO;QAC9B,UAAU;YAAE,MAAM;QAAO;QACzB,UAAU;YAAE,MAAM;QAAO;QACzB,WAAW;YAAE,MAAM;QAAO;IAC9B;IAEA,UAAU;QACN,YAAY;YAAE,MAAM,mHAAM,CAAC,KAAK,CAAC,QAAQ;YAAE,KAAK;QAAO;QACvD,YAAY;YAAE,MAAM,mHAAM,CAAC,KAAK,CAAC,QAAQ;YAAE,KAAK;QAAO;QACvD,YAAY;YAAE,MAAM;QAAK;QACzB,YAAY;YAAE,MAAM,mHAAM,CAAC,KAAK,CAAC,QAAQ;YAAE,KAAK;QAAO;QACvD,iBAAiB;YAAE,MAAM;QAAO;QAChC,YAAY;YAAE,MAAM;QAAK;QACzB,UAAU;YAAE,MAAM;QAAK;IAC3B;AACJ,GACA;IAAE,YAAY;AAAK;AAGvB,6BAA6B;AAC7B,eAAe,KAAK,CAAC;IAAE,uBAAuB;AAAE;AAChD,eAAe,KAAK,CAAC;IAAE,WAAW,CAAC;AAAE;uCAEtB,mHAAM,CAAC,QAAQ,IAAI,IAAA,kHAAK,EAAY,YAAY"}},
    {"offset": {"line": 203, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/USER/Desktop/A10%20Projects/SierraVaultMain/models/AuditLog.ts"],"sourcesContent":["import mongoose, { Schema, Document, model, models } from \"mongoose\";\r\n\r\nexport interface IAuditLog extends Document {\r\n    actorId: mongoose.Types.ObjectId; // User who performed the action\r\n    action: \"DOCUMENT_UPLOAD\" | \"DOCUMENT_VERIFIED\" | \"DOCUMENT_REJECTED\" | \"DOCUMENT_ISSUED\" | \"ACCESS_GRANTED\" | \"LOGIN_FAILURE\" | \"GOV_User_ADDED\" | \"DOCUMENT_DELETED_REJECTED\" | \"DOCUMENT_REQUESTED\";\r\n    targetId?: mongoose.Types.ObjectId; // Document ID or User ID being acted upon\r\n    targetModel?: \"Document\" | \"User\";\r\n    details?: Record<string, any>; // Flexible metadata (reason, IP, etc.)\r\n    ipAddress?: string;\r\n    userAgent?: string;\r\n    timestamp: Date;\r\n}\r\n\r\nconst AuditLogSchema = new Schema<IAuditLog>(\r\n    {\r\n        actorId: { type: Schema.Types.ObjectId, ref: \"User\", required: true, index: true },\r\n        action: {\r\n            type: String,\r\n            enum: [\r\n                \"DOCUMENT_UPLOAD\",\r\n                \"DOCUMENT_VERIFIED\",\r\n                \"DOCUMENT_REJECTED\",\r\n                \"DOCUMENT_ISSUED\",\r\n                \"ACCESS_GRANTED\",\r\n                \"LOGIN_FAILURE\",\r\n                \"GOV_USER_ADDED\",\r\n                \"DOCUMENT_DELETED_REJECTED\",\r\n                \"DOCUMENT_REQUESTED\",\r\n            ],\r\n            required: true,\r\n            index: true,\r\n        },\r\n        targetId: { type: Schema.Types.ObjectId, index: true },\r\n        targetModel: { type: String, enum: [\"Document\", \"User\"] },\r\n        details: { type: Schema.Types.Mixed },\r\n        ipAddress: { type: String },\r\n        userAgent: { type: String },\r\n        timestamp: { type: Date, default: Date.now, index: true },\r\n    },\r\n    { timestamps: { createdAt: true, updatedAt: false } } // Immutable logs\r\n);\r\n\r\nexport default models.AuditLog || model<IAuditLog>(\"AuditLog\", AuditLogSchema);\r\n"],"names":[],"mappings":";;;;AAAA;;AAaA,MAAM,iBAAiB,IAAI,mHAAM,CAC7B;IACI,SAAS;QAAE,MAAM,mHAAM,CAAC,KAAK,CAAC,QAAQ;QAAE,KAAK;QAAQ,UAAU;QAAM,OAAO;IAAK;IACjF,QAAQ;QACJ,MAAM;QACN,MAAM;YACF;YACA;YACA;YACA;YACA;YACA;YACA;YACA;YACA;SACH;QACD,UAAU;QACV,OAAO;IACX;IACA,UAAU;QAAE,MAAM,mHAAM,CAAC,KAAK,CAAC,QAAQ;QAAE,OAAO;IAAK;IACrD,aAAa;QAAE,MAAM;QAAQ,MAAM;YAAC;YAAY;SAAO;IAAC;IACxD,SAAS;QAAE,MAAM,mHAAM,CAAC,KAAK,CAAC,KAAK;IAAC;IACpC,WAAW;QAAE,MAAM;IAAO;IAC1B,WAAW;QAAE,MAAM;IAAO;IAC1B,WAAW;QAAE,MAAM;QAAM,SAAS,KAAK,GAAG;QAAE,OAAO;IAAK;AAC5D,GACA;IAAE,YAAY;QAAE,WAAW;QAAM,WAAW;IAAM;AAAE,EAAE,iBAAiB;;uCAG5D,mHAAM,CAAC,QAAQ,IAAI,IAAA,kHAAK,EAAY,YAAY"}},
    {"offset": {"line": 269, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/USER/Desktop/A10%20Projects/SierraVaultMain/app/api/documents/%5Bid%5D/view/route.ts"],"sourcesContent":["import { NextResponse } from 'next/server';\r\nimport dbConnect from '@/lib/dbConnect';\r\nimport Document from '@/models/Document';\r\nimport { jwtVerify } from 'jose';\r\nimport AuditLog from '@/models/AuditLog';\r\n\r\nconst JWT_SECRET = process.env.JWT_SECRET || \"fallback-secret-change-me\";\r\nconst SECRET_KEY = new TextEncoder().encode(JWT_SECRET);\r\n\r\nexport async function GET(req: Request, { params }: { params: Promise<{ id: string }> }) {\r\n    try {\r\n        await dbConnect();\r\n        const { id: docId } = await params;\r\n\r\n        // Auth Check: Needs Step-Up Token\r\n        const authHeader = req.headers.get('Authorization');\r\n        if (!authHeader || !authHeader.startsWith('Bearer ')) {\r\n            return NextResponse.json({ error: 'Step-Up Authentication Required' }, { status: 401 });\r\n        }\r\n\r\n        const token = authHeader.split(' ')[1];\r\n        let payload;\r\n        try {\r\n            const verified = await jwtVerify(token, SECRET_KEY);\r\n            payload = verified.payload;\r\n        } catch (e) {\r\n            return NextResponse.json({ error: 'Invalid or Expired Step-Up Token' }, { status: 401 });\r\n        }\r\n\r\n        // @ts-ignore\r\n        if (payload.scope !== 'document_access') {\r\n            return NextResponse.json({ error: 'Insufficient Token Scope' }, { status: 403 });\r\n        }\r\n\r\n        const doc = await Document.findById(docId);\r\n        if (!doc) {\r\n            return NextResponse.json({ error: 'Document not found' }, { status: 404 });\r\n        }\r\n\r\n        // RBAC: Can user view this? (Owner or Gov)\r\n        // @ts-ignore\r\n        const requestorId = payload.id;\r\n        // @ts-ignore\r\n        const requestorRole = payload.role;\r\n\r\n        if (requestorRole !== 'citizen' && !requestorRole.startsWith('gov_')) {\r\n            // Fallback safety\r\n            return NextResponse.json({ error: 'Forbidden' }, { status: 403 });\r\n        }\r\n\r\n        if (requestorRole === 'citizen' && doc.userId.toString() !== requestorId) {\r\n            return NextResponse.json({ error: 'Forbidden: Not your document' }, { status: 403 });\r\n        }\r\n\r\n        // Audit Log Access\r\n        await AuditLog.create({\r\n            actorId: requestorId,\r\n            action: 'ACCESS_GRANTED',\r\n            targetId: doc._id,\r\n            targetModel: 'Document',\r\n            details: { method: 'Step-Up' }\r\n        });\r\n\r\n        // Return the secure URL (or signed URL in real implementation)\r\n        return NextResponse.json({ url: doc.url });\r\n\r\n    } catch (error) {\r\n        console.error(\"Secure View Error:\", error);\r\n        return NextResponse.json({ error: 'Internal Server Error' }, { status: 500 });\r\n    }\r\n}\r\n"],"names":[],"mappings":";;;;AAAA;AACA;AACA;AACA;AACA;;;;;;AAEA,MAAM,aAAa,QAAQ,GAAG,CAAC,UAAU,IAAI;AAC7C,MAAM,aAAa,IAAI,cAAc,MAAM,CAAC;AAErC,eAAe,IAAI,GAAY,EAAE,EAAE,MAAM,EAAuC;IACnF,IAAI;QACA,MAAM,IAAA,6HAAS;QACf,MAAM,EAAE,IAAI,KAAK,EAAE,GAAG,MAAM;QAE5B,kCAAkC;QAClC,MAAM,aAAa,IAAI,OAAO,CAAC,GAAG,CAAC;QACnC,IAAI,CAAC,cAAc,CAAC,WAAW,UAAU,CAAC,YAAY;YAClD,OAAO,+QAAY,CAAC,IAAI,CAAC;gBAAE,OAAO;YAAkC,GAAG;gBAAE,QAAQ;YAAI;QACzF;QAEA,MAAM,QAAQ,WAAW,KAAK,CAAC,IAAI,CAAC,EAAE;QACtC,IAAI;QACJ,IAAI;YACA,MAAM,WAAW,MAAM,IAAA,uNAAS,EAAC,OAAO;YACxC,UAAU,SAAS,OAAO;QAC9B,EAAE,OAAO,GAAG;YACR,OAAO,+QAAY,CAAC,IAAI,CAAC;gBAAE,OAAO;YAAmC,GAAG;gBAAE,QAAQ;YAAI;QAC1F;QAEA,aAAa;QACb,IAAI,QAAQ,KAAK,KAAK,mBAAmB;YACrC,OAAO,+QAAY,CAAC,IAAI,CAAC;gBAAE,OAAO;YAA2B,GAAG;gBAAE,QAAQ;YAAI;QAClF;QAEA,MAAM,MAAM,MAAM,+HAAQ,CAAC,QAAQ,CAAC;QACpC,IAAI,CAAC,KAAK;YACN,OAAO,+QAAY,CAAC,IAAI,CAAC;gBAAE,OAAO;YAAqB,GAAG;gBAAE,QAAQ;YAAI;QAC5E;QAEA,2CAA2C;QAC3C,aAAa;QACb,MAAM,cAAc,QAAQ,EAAE;QAC9B,aAAa;QACb,MAAM,gBAAgB,QAAQ,IAAI;QAElC,IAAI,kBAAkB,aAAa,CAAC,cAAc,UAAU,CAAC,SAAS;YAClE,kBAAkB;YAClB,OAAO,+QAAY,CAAC,IAAI,CAAC;gBAAE,OAAO;YAAY,GAAG;gBAAE,QAAQ;YAAI;QACnE;QAEA,IAAI,kBAAkB,aAAa,IAAI,MAAM,CAAC,QAAQ,OAAO,aAAa;YACtE,OAAO,+QAAY,CAAC,IAAI,CAAC;gBAAE,OAAO;YAA+B,GAAG;gBAAE,QAAQ;YAAI;QACtF;QAEA,mBAAmB;QACnB,MAAM,+HAAQ,CAAC,MAAM,CAAC;YAClB,SAAS;YACT,QAAQ;YACR,UAAU,IAAI,GAAG;YACjB,aAAa;YACb,SAAS;gBAAE,QAAQ;YAAU;QACjC;QAEA,+DAA+D;QAC/D,OAAO,+QAAY,CAAC,IAAI,CAAC;YAAE,KAAK,IAAI,GAAG;QAAC;IAE5C,EAAE,OAAO,OAAO;QACZ,QAAQ,KAAK,CAAC,sBAAsB;QACpC,OAAO,+QAAY,CAAC,IAAI,CAAC;YAAE,OAAO;QAAwB,GAAG;YAAE,QAAQ;QAAI;IAC/E;AACJ"}}]
}